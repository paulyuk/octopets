name: Deploy with AZD and OIDC

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Required permissions for OIDC
permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      DOTNET_CORE_VERSION: 9.0.x
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_CORE_VERSION }}
 
      - name: Install azd
        uses: Azure/setup-azd@v2

      - name: Configure Azure CLI authentication
        shell: bash
        run: |
          echo "üîë Setting up Azure CLI authentication..."
          export AZURE_CLIENT_ID="${{ vars.AZURE_CLIENT_ID }}"
          export AZURE_TENANT_ID="${{ vars.AZURE_TENANT_ID }}"
          export AZURE_SUBSCRIPTION_ID="${{ vars.AZURE_SUBSCRIPTION_ID }}"
          
          # Display last 4 characters of client ID for debugging
          if [[ -n "$AZURE_CLIENT_ID" ]]; then
            CLIENT_ID_LENGTH=${#AZURE_CLIENT_ID}
            LAST_FOUR=${AZURE_CLIENT_ID:$CLIENT_ID_LENGTH-4:4}
            echo "üîë Using client ID ending with: $LAST_FOUR"
          else
            echo "‚ö†Ô∏è Client ID is not set"
          fi

      - name: Log in with Azure (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Set Docker Image Tag Environment Variable
        run: |
          # Using a descriptive tag that combines branch, run number, and short SHA
          # This is the best practice for traceability and immutability.
          COMMIT_SHA_SHORT=${GITHUB_SHA::7}
          IMAGE_TAG="${{ github.ref_name }}-${{ github.run_number }}-${COMMIT_SHA_SHORT}"
          export AZURE_CONTAINER_IMAGE_TAG=${IMAGE_TAG}

          echo "AZURE_CONTAINER_IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          echo "Generated image tag: ${IMAGE_TAG}"

      - name: Deploy with azd
        shell: bash
        run: |
          export AZURE_ENV_NAME=${{ vars.AZURE_ENV_NAME || 'octopets' }}
          export AZURE_LOCATION="${{ vars.AZURE_LOCATION || 'eastus2' }}"
          export AZURE_SUBSCRIPTION_ID="${{ vars.AZURE_SUBSCRIPTION_ID }}"
          export AZURE_CLIENT_ID="${{ vars.AZURE_CLIENT_ID }}"
          export AZURE_TENANT_ID="${{ vars.AZURE_TENANT_ID }}"

          echo "üîç Diagnostic information:"
          echo "AZD version: $(azd version)"
          echo "Current OIDC token: $(if [[ -n $ACTIONS_ID_TOKEN_REQUEST_TOKEN ]]; then echo 'Present'; else echo 'Not found'; fi)"

          echo "üöÄ Starting deployment with azd..."
          echo "Environment: $AZURE_ENV_NAME"
          echo "Location: $AZURE_LOCATION"
          echo "Azure container image tag: $AZURE_CONTAINER_IMAGE_TAG"

          azd auth login --client-id $AZURE_CLIENT_ID --federated-credential-provider github --tenant-id $AZURE_TENANT_ID

          echo "üîç Changing working directory to ./apphost ..."
          pwd
          cd apphost
          pwd

          if ! azd env select $AZURE_ENV_NAME 2>/dev/null; then
            echo "üì¶ Creating new azd environment: $AZURE_ENV_NAME"
            azd env new $AZURE_ENV_NAME --location $AZURE_LOCATION --subscription $AZURE_SUBSCRIPTION_ID
          fi

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîç PR detected - running provision with preview"
            azd provision --preview
          else
            echo "üöÄ Main branch - deploying application"
            # Set container image tag before running azd up
            azd env set AZURE_CONTAINER_IMAGE_TAG $AZURE_CONTAINER_IMAGE_TAG
            echo "‚úÖ Set container image tag to: $AZURE_CONTAINER_IMAGE_TAG"
            
            # Run azd up with the correct environment name
            azd up --no-prompt --debug
            
            # Add resource tag to container app with the image tag
            echo "üè∑Ô∏è Adding resource tag to container app..."
            # Get the container app resource ID
            RESOURCE_GROUP=$(azd env get-values | grep AZURE_RESOURCE_GROUP | cut -d '=' -f2)
            CONTAINER_APP_NAME=$(azd env get-values | grep AZURE_CONTAINER_APPS_ENDPOINT | cut -d '.' -f1)
            
            if [ -n "$RESOURCE_GROUP" ] && [ -n "$CONTAINER_APP_NAME" ]; then
              echo "Resource Group: $RESOURCE_GROUP, Container App: $CONTAINER_APP_NAME"
              # Tag the container app resource with the image tag
              az tag update --resource-id "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.App/containerApps/$CONTAINER_APP_NAME" \
                            --operation Merge \
                            --tags "AZURE_CONTAINER_IMAGE_TAG=$AZURE_CONTAINER_IMAGE_TAG"
              echo "‚úÖ Container app tagged with image tag: $AZURE_CONTAINER_IMAGE_TAG"
            else
              echo "‚ö†Ô∏è Could not determine container app details for tagging"
            fi
          fi

      - name: Get deployment outputs
        if: github.event_name != 'pull_request'
        shell: bash
        run: |
          echo "üìã Getting deployment information..."
          azd show --output table || true
